-- Readmission rate at the encounter level, stratified by random_flag
-- Definition: readmission events = ALL Admissions within 30 days after discharge
--             for the same patient, different CSN, with pat_class IN ('Inpatient','Observation')
-- Notes:
--   • Counts ALL qualifying readmission encounters in the 30-day window (not just the first).
--   • Reports both the % of index encounters with >=1 readmission AND the total number of readmission events.
--   • Also includes the mean number of readmission events per index encounter.

WITH random_flag AS (
  SELECT 
    anon_id, 
    pat_enc_csn_id_coded, 
    smrtdta_elem_value AS random_flag 
  FROM `som-nero-phi-jonc101-secure.shc_core_updates.shc_smrtdta` 
  WHERE concept_id = 'SHC#6051'
),

discharges_selected AS (
  SELECT 
    a.anon_id, 
    a.pat_enc_csn_id_coded, 
    a.event_time_jittered AS dis_time
  FROM `som-nero-phi-jonc101-secure.shc_core_updates.shc_adt` a
  INNER JOIN `som-nero-phi-jonc101-secure.shc_core_updates.shc_dep_map` d USING (department_id)
  INNER JOIN `som-nero-phi-jonc101-secure.starr_map.shc_map_2025-04-15` m USING (anon_id)
  WHERE 
    a.event_type = 'Discharge' 
    AND (
      UPPER(d.department_name) LIKE 'B3' OR
      UPPER(d.department_name) LIKE 'C3' OR
      UPPER(d.department_name) LIKE 'M7' OR
      UPPER(d.department_name) LIKE 'L7' OR
      UPPER(d.department_name) LIKE '1%WEST%' OR
      UPPER(d.department_name) LIKE '2%NORTH%' OR
      UPPER(d.department_name) LIKE '2%WEST%' OR
      UPPER(d.department_name) LIKE '3%WEST%'
    )
    AND a.effective_time_jittered - INTERVAL m.jitter DAY BETWEEN '2024-08-15' AND '2025-03-15'
),

admissions_all AS (
  SELECT 
    anon_id, 
    pat_enc_csn_id_coded, 
    event_time_jittered AS adm_time,
    pat_class
  FROM `som-nero-phi-jonc101-secure.shc_core_updates.shc_adt`
  WHERE event_type = 'Admission'
),

-- Count ALL qualifying readmission events within 30 days per index encounter
readmissions_30d AS (
  SELECT
    d.anon_id,
    d.pat_enc_csn_id_coded AS index_encounter,
    d.dis_time,
    COUNT(a.pat_enc_csn_id_coded) AS readmit_events_30d
  FROM discharges_selected d
  LEFT JOIN admissions_all a
    ON a.anon_id = d.anon_id
   AND a.pat_enc_csn_id_coded != d.pat_enc_csn_id_coded
   AND a.pat_class IN ('Inpatient','Observation')
   AND a.adm_time > d.dis_time
   AND a.adm_time <= d.dis_time + INTERVAL 30 DAY
  GROUP BY d.anon_id, index_encounter, d.dis_time
),

-- Attach randomization flag; compute both a binary flag (>=1 readmission) and the event count
readmission_flags AS (
  SELECT
    rf.random_flag,
    r.anon_id,
    r.index_encounter AS pat_enc_csn_id_coded,
    r.dis_time,
    IFNULL(r.readmit_events_30d, 0) AS readmit_events_30d,
    CASE WHEN IFNULL(r.readmit_events_30d, 0) > 0 THEN 1 ELSE 0 END AS any_readmit_30d
  FROM readmissions_30d r
  INNER JOIN random_flag rf
    ON r.anon_id = rf.anon_id
   AND r.index_encounter = rf.pat_enc_csn_id_coded
)

-- Final summary by random_flag (+ grand total via ROLLUP)
SELECT
  IFNULL(CAST(random_flag AS STRING), 'ALL') AS random_flag,
  COUNT(*) AS total_index_encounters,
  SUM(any_readmit_30d) AS encounters_with_ge_1_readmit_30d,
  SUM(readmit_events_30d) AS total_readmission_events_30d,
  SAFE_DIVIDE(SUM(any_readmit_30d), COUNT(*)) AS pct_with_ge_1_readmit_30d,
  SAFE_DIVIDE(SUM(readmit_events_30d), COUNT(*)) AS mean_readmit_events_per_index_encounter_30d
FROM readmission_flags
GROUP BY ROLLUP(random_flag)
ORDER BY CASE WHEN random_flag = 'ALL' THEN 1 ELSE 0 END, random_flag;
